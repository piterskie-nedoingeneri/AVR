//немного трешнявый код для псевдо игровой приставки
#define F_CPU 16000000
#define byte uint8_t
#include <avr/io.h>
#include <util/delay.h>
#include <avr/interrupt.h>
#define PORT1 PORTB
#define PIN1 PINC
#define cmode_off() PORT1|=1<<DC //режим передачи графики
#define cmode_on() PORT1&=~(1<<DC) //режим передачи команд
#define stop() PORT1|=1<<CE
#define start() PORT1&=~(1<<CE)
#define DIN 3
#define DC 2
#define CE 1
#define CLK 4
#define RESET 0
/*
#define E5_ 23
#define D5_ 26
#define C5_ 30
#define B4_ 32
#define A4_ 36
*/
#define E5_ 94
#define D5_ 107
#define C5_ 113
#define B4_ 127
#define A4_ 142
byte die [] = {
	0x17, 0x14, 0x0F, 0x00, 0x1F, 0x02, 0x04, 0x02, 0x1F, 0x00, 0x1F, 0x15, 0x11, 0x00, 0x1F, 0x05,
	0x07, 0x00, 0x1F, 0x15, 0x11, 0x00, 0x01, 0x1F, 0x01, 0x00, 0x1F, 0x14, 0x1C, 0x00,
};
byte Raftalia [] = {
	0x00, 0x00, 0x00, 0x00, 0xE0, 0x30, 0x18, 0x18, 0x38, 0x38, 0x78, 0x30, 0x30, 0x20, 0x30, 0x10,
	0x10, 0x08, 0x28, 0x08, 0x08, 0x44, 0x44, 0x24, 0x04, 0x04, 0x04, 0x08, 0x08, 0x48, 0x98, 0x24,
	0x24, 0x3A, 0x0E, 0x47, 0x83, 0x09, 0x51, 0xA3, 0x1C, 0x78, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x7E,
	0x0A, 0x04, 0x70, 0x28, 0x70, 0x00, 0x30, 0x48, 0xF8, 0x48, 0x30, 0x00, 0x08, 0x78, 0x08, 0x00,
	0x70, 0x28, 0x70, 0x00, 0x70, 0x08, 0x78, 0x00, 0x78, 0x20, 0x10, 0x78, 0x00, 0x50, 0x28, 0x78,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0xA0, 0x56, 0x28, 0x88, 0x88, 0x0E, 0x01,
	0x01, 0xC0, 0xF0, 0x0E, 0x01, 0x00, 0x80, 0x30, 0x8E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x81, 0x40, 0x40, 0x00, 0x01, 0x1E, 0xE0, 0x01, 0x06, 0x09, 0x00, 0x80, 0x3F, 0xC0,
	0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x11, 0x3C, 0x00, 0x38,
	0x14, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x38, 0x04, 0x03, 0x00, 0xE0, 0x1C,
	0x9F, 0x9F, 0x80, 0x78, 0x18, 0x08, 0x07, 0x18, 0x20, 0x86, 0xF9, 0x00, 0x0B, 0x18, 0x18, 0x40,
	0x80, 0xFE, 0x18, 0x80, 0xE0, 0x58, 0x87, 0xC7, 0xC7, 0xE0, 0x98, 0x1E, 0x01, 0x60, 0x00, 0x00,
	0x00, 0xE0, 0x1F, 0x00, 0x07, 0x07, 0xFC, 0x00, 0x3E, 0x04, 0x08, 0x04, 0x3E, 0x00, 0x3C, 0x10,
	0x08, 0x3C, 0x00, 0x3C, 0x10, 0x3C, 0x00, 0x3C, 0x10, 0x08, 0x3C, 0x00, 0x3C, 0x08, 0x10, 0x08,
	0x3C, 0x00, 0x38, 0x14, 0x38, 0x00, 0x3C, 0x90, 0x2C, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x01, 0x3F, 0xF0, 0x00, 0x02, 0x02, 0x1F, 0x1F, 0x1F, 0x1F, 0x0F, 0x01, 0x07,
	0x00, 0x40, 0x40, 0x00, 0x00, 0x01, 0x03, 0x00, 0x00, 0x03, 0x0F, 0x0F, 0x0F, 0x4F, 0x2F, 0x37,
	0x2C, 0xF0, 0x18, 0x84, 0x0D, 0x03, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x70, 0x80, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xB7, 0x42, 0xB7, 0x00, 0x00, 0x00,
	0xF3, 0x1C, 0x20, 0xC0, 0x0C, 0xF8, 0x20, 0xC0, 0x00, 0x0F, 0x7C, 0xC0, 0x80, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x30, 0xF8, 0xF8, 0x38, 0x38, 0x38, 0x38, 0x30, 0x00, 0x00, 0x00, 0x00,
	0x00, 0xC0, 0x20, 0x10, 0xE8, 0x00, 0x03, 0x00, 0xC0, 0x00, 0x20, 0xD0, 0x0F, 0x0F, 0x00, 0x00,
	0x0F, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0xE1, 0x3E, 0xE0, 0x81, 0x09, 0x36, 0x49, 0x80, 0x08, 0x08, 0x19, 0x40,
	0x43, 0xFE, 0xFC, 0xF8, 0x70, 0xE0, 0x60, 0x60, 0x40, 0x40, 0x40, 0x81, 0x81, 0x81, 0x80, 0x80,
	0x40, 0xC0, 0x60, 0x50, 0x50, 0xFE, 0x1E, 0xD1, 0x26, 0x80, 0x70, 0x0F, 0x08, 0x06, 0x01, 0x00,
	0x80, 0x80, 0xF8, 0xFF, 0xFE, 0xF8, 0x98, 0x60, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};
byte contar [] = {
	0x00,0x7F, 0x01, 0x7F, 0x00, 0x7E, 0x0A, 0x0E, 0x00, 0x3C, 0x42, 0x3C, 0x00, 0x40, 0x20, 0x3C, 0x22,
	0x3C, 0x40, 0x00, 0x3C, 0x42, 0x3C, 0x00, 0x40, 0x3C, 0x02, 0x7E, 0x00, 0x46, 0x28, 0x10, 0x7E,
	0x10, 0x28, 0x46, 0x00, 0x7E, 0x20, 0x10, 0x7E, 0x00, 0x02, 0x7E, 0x02, 0x00, 0x7E, 0x50, 0x20,
	0x00, 0x00, 0x00, 0x46, 0x28, 0x10, 0x7E, 0x10, 0x28, 0x46, 0x00, 0x7E, 0x20, 0x10, 0x7E, 0x00,
	0x02, 0x7E, 0x02, 0x00, 0x7E, 0x50, 0x20, 0x00,
};
byte ex[]={0xFE, 0x92, 0x6C, 0x00, 0xFC, 0xA0, 0xC0, 0x00, 0xFC, 0x00, 0xCC, 0x30, 0xCC, 0x00, 0x78, 0x84,
0x78, 0x00, 0x80, 0x40, 0x78, 0x44, 0x7C, 0x80};
byte new_game[]={
	0xfe, 0x10, 0xfe, 0x00, 0x78, 0x84, 0x78, 0x00, 0xFC, 0xA4, 0x58, 0x00, 0xF0, 0x4C, 0xF0, 0x00,
	0xB8, 0x44, 0xFC, 0x00, 0x00, 0x00, 0xFC, 0x40, 0x20, 0xFC, 0x00, 0xFC, 0x04, 0x04, 0x00, 0xFC,
0x24, 0x18, 0x00, 0xF0, 0x4C, 0xF0, 0x00, 0x00};
byte contin[]={0xFE, 0x02, 0x02, 0xFE, 0x00, 0xFC, 0x24, 0x18, 0x00, 0x78, 0x84, 0x78, 0x00, 0xC0, 0x70, 0x4C,
	0x70, 0xC0, 0x00, 0x78, 0x84, 0x78, 0x00, 0xF0, 0x0C, 0xF0, 0x00, 0x00, 0xDC, 0x20, 0xFC, 0x20,
0xDC, 0x00, 0xFC, 0x40, 0x20, 0xFC, 0x00, 0x04, 0x04, 0xFC, 0x04, 0x00, 0xFC, 0xA0, 0x40};
byte skyrim[]={0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0xC0, 0xFC, 0x7E, 0x1C, 0x10, 0x00, 0x00, 0x00, 0x70, 0x78, 0x3E, 0x1C,
	0x8C, 0x9E, 0xFA, 0x70, 0x00, 0x00, 0x20, 0x38, 0x7E, 0x7C, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x80, 0xF8, 0xFC, 0xFF, 0xFF, 0x8F, 0x03, 0x06, 0x04, 0x00, 0x00, 0x30, 0xE0,
	0xE0, 0xE0, 0xFE, 0xFF, 0xFB, 0xF9, 0xE1, 0xE0, 0x20, 0x00, 0x00, 0x00, 0x06, 0x02, 0x03, 0xCF,
	0xFF, 0xFE, 0xF0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x1C, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x3C, 0x3C,
	0x7C, 0xFE, 0x3F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x3F, 0x7C, 0x7C,
	0x3C, 0x3C, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x1C, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x1F, 0x3F, 0x3F,
	0xF8, 0xC0, 0xC0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0xF9, 0x0F, 0x0F, 0x01, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0xE0, 0xC0, 0xC0, 0xF8, 0x3F, 0x1F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x01, 0x0F, 0x3F, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x7D, 0xC7,
	0xC0, 0xE0, 0xF0, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x0F, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x1E, 0x2A,
	0x2A, 0x2E, 0x00, 0x24, 0x2A, 0x2A, 0x12, 0x00, 0x40, 0x46, 0x58, 0x60, 0x58, 0x46, 0x40, 0x00,
	0x00, 0x00, 0x00, 0x2E, 0x2A, 0x3A, 0x00, 0x3E, 0x08, 0x36, 0x20, 0x00, 0x26, 0x28, 0x1E, 0x00,
	0x3E, 0x0A, 0x36, 0x00, 0x22, 0x3E, 0x22, 0x00, 0x3E, 0x04, 0x08, 0x04, 0x3E, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
byte music[] ={D5_,C5_,D5_,D5_,0,D5_,C5_,D5_,D5_,0,C5_,D5_,E5_,E5_,D5_,C5_,C5_,B4_,B4_,0,B4_,
	A4_,B4_,B4_,0,B4_,A4_,B4_,B4_,0,B4_,A4_,C5_,C5_,D5_,D5_,A4_,A4_,B4_,B4_};
/*
Частоты нот	| счетчик | полубайт
E4	=	329		94		1
D4	=	293		107		2
C4#	=	277		113		3
B3	=	246		127		4
A3	=	220		142 	5
null					0
*/
void input(byte inp)
{
	start();
	byte buff=0x80;
	while(buff!=0x00)
	{
		
		PORT1&=~(1<<CLK);
		if((buff&inp)!=0x00)
		{
			PORT1|=1<<DIN;
			
		}
		else
		{
			PORT1&=~(1<<DIN);
		}
		
		//PORTA&=0b11110111;
		PORT1|=1<<CLK;
		buff>>=1;
	}
	stop();
}
void init_displ()
{
	//_delay_ms(1000);
	//_____RESET_____
	PORT1&=~(1<<RESET);
	PORT1|=1<<RESET;
	//________________
	
	cmode_on();
	input(0x21);
	input(0x80 + 34);
	input(0x04);
	input(0x13);
	input(0x20);
	input(0x0c);
	cmode_off();
}
void setpos(byte a, byte b)
{
	cmode_on();
	input(0x40 | (a&7));
	input(0x80 | b);
	cmode_off();
}
void clear()
{
	setpos(0,0);
	for (uint8_t y = 0; y < 6; y++)
	for (uint8_t x = 0; x < 84; x++)
	input(0);
	setpos(0,0);
}
void draw_skyrim()
{
	setpos(0,0);
	for(uint16_t i = 0;i<504;i++)
	{
		input(skyrim[i]);
	}
}
void draw_raf()
{
	setpos(0,0);
	for(uint16_t i = 0;i<504;i++)
	{
		input(Raftalia[i]);
	}
}

void draw_line(uint8_t x, uint8_t y, uint8_t len, byte *line, byte inver)
{
	
	for(uint8_t i=0;i<len;i++)
	{
		setpos(y,x+i);
		if(inver) input(~line[i]);
		else input(line[i]);
	}
	
}
void in_game()
{
	clear();
	byte menu=0x01;
	byte buff0=0;
	while(1)
	{
		if((!(PIN1&(1<<PC3)))&&(menu<0x2))
		{
			menu<<=1;
			_delay_ms(200);
		}
		if((!(PIN1&(1<<PC2)))&&(menu!=1))
		{
			menu>>=1;
			_delay_ms(200);
		}
		if(!(PIN1&(1<<PC1)))
		{
			if(menu==2)
			{
				_delay_ms(200);
				break;
			}
			else
			{
				draw_line(2,1,73,&contar,0);
				draw_line(2,2,30,&die,0);
				_delay_ms(50);
				buff0=0;
			}
		}

		if(buff0 != menu)
		{
			draw_line(2,1,73,&contar,menu&1);
			draw_line(2,2,30,&die,(menu&2)>>1);
		}
	}
}
void init_t0(byte note)
{
	TCCR0A = (1<<WGM01);
	TCCR0B=(1<<CS00)|(1<<CS02);//сброс по совпадению делитель на 1024
	OCR0A = note;//число для сравнения
	/*в итоге получаем частоту равную ~2 Кгц
	такм образом можно получить звук частотой 1 кгц (один такт - 0 второй такт - 1)
	*/
	TIMSK0 = (1<<OCIE0A);
 
}
void init_t1()
{
	TCCR1B=(1<<CS10)|(1<<CS12)|(1<<WGM12);
	OCR1AH=0b00001000;
	OCR1AL=0x00;
	TIMSK1=(1<<OCIE1A);//разрешаем прерыв
}
uint8_t buff=1;
uint8_t buff3=0;
ISR(TIMER0_COMPA_vect)
{
	if(buff)//нота не пуста
	{
		if(buff3)
		{
			PORTC|=(1<<PC5);
			buff3=0;
		}
		else
		{
			PORTC&=~(1<<PC5);
			buff3=1;
		}
	}
}
uint8_t ind=0;
uint8_t buff2=0;

ISR(TIMER1_COMPA_vect)
{
	if(ind<40) ind++;
	else ind=0;
	init_t0(music[ind]/2);
	if(music[ind]==0) buff=0;
	else buff=1;
}
int main(void)
{
	DDRD=0x0;
	PORTD=0x0f;
	DDRB=0x1F;
	DDRC=0x00|(1<<PC5);// PC5 на выход (музыка)
	PORTC=0x0f;//
	PORTB=0x00;
	init_displ();
	clear();
	uint8_t page=1;
	byte buff=0;
	draw_skyrim();
	/*
	draw_line(0,0,40,&new_game,page&1);
	draw_line(0,1,47,&contin,(page&2)>>1);
	draw_line(0,2,24,&ex,(page&4)>>2);*/
	sei();//разрешаем прерывания (музыка)
	init_t0(music[0]/2);
	init_t1();
	while(1)
	{ 	
		if(buff!=page)
		{
			draw_line(0,0,40,&new_game,page&0x01);
			draw_line(0,1,47,&contin,(page&0x02)>>1);
			draw_line(0,2,24,&ex,(page&4)>>2);
			buff=page;
		}
		if((!(PIN1&(1<<PC3)))&&(page<0x4))
		{
			page<<=1;
			_delay_ms(200);
		}
		if((!(PIN1&(1<<PC2)))&&(page!=1))
		{
			page>>=1;
			_delay_ms(200);
		}
		if((!(PIN1&(1<<PC1)))&&(page!=4))
		{
			in_game();
			draw_skyrim();
			buff=0;//сбрасываем буфер
			page=0x04;
		}
		if(!(PIND&(1<<PD1)))
		{
			draw_raf();
			_delay_ms(5000);
			draw_skyrim();
			buff=0;
		}
	}
	
}


